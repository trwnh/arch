#!/bin/bash
# wifi-menu
# wget https://raw.githubusercontent.com/trwnh/arch/master/script/ux301.1
# chmod +x ux301.1
# ./ux301.1

setfont latarcyrheb-sun32 # readable tty font for hidpi
timedatectl set-ntp true # network time
parted -s /dev/sda mklabel gpt
sgdisk -n 0:0:+512M -t 0:ef00 -c 0:"ESP" /dev/sda
sgdisk -n 0:0:0 -t 0:8300 -c 0:"Root" /dev/sda
partprobe /dev/sda
echo "Partions made."
mkfs.fat /dev/sda1 -n "ESP"
mkfs.ext4 /dev/sda2 -L "Arch" -F
echo "Filesystems created."
mount /dev/sda2 /mnt
mkdir /mnt/boot
mount /dev/sda1 /mnt/boot
mkdir /mnt/storage
mount /dev/sdb1 /mnt/storage
echo "Mounting complete."
pacman -Sy
pacman -S reflector --noconfirm
reflector --country 'US' -p http --sort rate --save /etc/pacman.d/mirrorlist
echo "Pacman mirrors synced and sorted."

BASE="base base-devel"
UTIL="openssh wget git zip unzip unrar nmap htop"
HW="intel-ucode vulkan-intel acpi bluez" # i7-4558U with Iris 5100, battery, bluetooth
NET="networkmanager nm-connection-editor"
AUDIO="pulseaudio pulseaudio-alsa pulseaudio-bluetooth pavucontrol"
PRINT="cups cups-pdf"

PACKAGES="$BASE $UTIL $HW $NET $AUDIO $PRINT"
pacstrap /mnt $PACKAGES 
genfstab -U /mnt >> /mnt/etc/fstab
echo "Filesystem table generated."
echo -ne "Starting chroot in 3 seconds"
for i in 1 2 3
do
  echo -ne "."
  sleep 1
done
arch-chroot /mnt sh -c "$(curl https://raw.githubusercontent.com/trwnh/arch/master/script/ux301.2)"
